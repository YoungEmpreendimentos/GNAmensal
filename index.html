<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard Financeiro</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
    body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; }
    .tab-button.active { border-color: #3b82f6; background-color: #3b82f6; color: white; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .loader { border: 8px solid #f3f3f3; border-top: 8px solid #3b82f6; border-radius: 50%; width: 60px; height: 60px; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>
</head>
<body class="p-4 md:p-8">

  <div id="loading-screen" class="fixed inset-0 bg-white bg-opacity-90 flex flex-col justify-center items-center z-50">
    <div class="loader"></div>
    <p class="mt-4 text-lg text-slate-700">Carregando dados da planilha...</p>
  </div>

  <div id="dashboard-container" class="max-w-7xl mx-auto hidden">
    <header class="mb-6">
      <h1 class="text-3xl font-bold text-slate-800">Dashboard Financeiro</h1>
      <p class="text-slate-600">Análise de Despesas por Centro de Custo</p>
    </header>

    <div class="mb-6 bg-white p-4 rounded-lg shadow-sm">
      <label for="month-filter" class="block text-sm font-medium text-slate-700 mb-2">Filtrar por Mês:</label>
      <select id="month-filter" class="w-full md:w-1/3 p-2 border border-slate-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
        <option value="all">Todo o período</option>
      </select>
    </div>

    <div class="mb-4 border-b border-slate-200">
      <nav class="flex flex-wrap -mb-px" id="tab-buttons">
        <button data-tab="cc1000" class="tab-button active text-slate-600 hover:text-blue-600 py-4 px-6 border-b-2 font-medium text-sm transition-colors duration-200">CC 1000 - Empreendimentos</button>
        <button data-tab="cc2000" class="tab-button text-slate-600 hover:text-blue-600 py-4 px-6 border-b-2 font-medium text-sm transition-colors duration-200">CC 2000 - Matriz</button>
        <button data-tab="cc2002" class="tab-button text-slate-600 hover:text-blue-600 py-4 px-6 border-b-2 font-medium text-sm transition-colors duration-200">CC 2002 - Novos Negócios</button>
        <button data-tab="total" class="tab-button text-slate-600 hover:text-blue-600 py-4 px-6 border-b-2 font-medium text-sm transition-colors duration-200">Total Geral</button>
        <button data-tab="chart" class="tab-button text-slate-600 hover:text-blue-600 py-4 px-6 border-b-2 font-medium text-sm transition-colors duration-200">Gráfico Comparativo</button>
      </nav>
    </div>

    <div id="tab-contents">
      <div id="cc1000" class="tab-content active p-4 bg-white rounded-lg shadow"></div>
      <div id="cc2000" class="tab-content p-4 bg-white rounded-lg shadow"></div>
      <div id="cc2002" class="tab-content p-4 bg-white rounded-lg shadow"></div>
      <div id="total" class="tab-content p-4 bg-white rounded-lg shadow"></div>
      <div id="chart" class="tab-content p-4 bg-white rounded-lg shadow" style="height: 400px;">
        <canvas id="mainChart"></canvas>
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/papaparse/5.3.2/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js" onload="initializeDashboard()"></script>

  <script>
  function initializeDashboard() {
    const URLS = {
      '1000': 'https://docs.google.com/spreadsheets/d/e/.../pub?gid=...&single=true&output=csv',
      '2000': 'https://docs.google.com/spreadsheets/d/e/.../pub?gid=...&single=true&output=csv',
      '2002': 'https://docs.google.com/spreadsheets/d/e/.../pub?gid=...&single=true&output=csv'
    };
    let allData = [], mainChartInstance = null;

    const monthFilter = document.getElementById('month-filter');
    const tabButtonsContainer = document.getElementById('tab-buttons');
    const tabContentsContainer = document.getElementById('tab-contents');
    const loadingScreen = document.getElementById('loading-screen');
    const dashboardContainer = document.getElementById('dashboard-container');

    function formatCurrency(value) {
      if (typeof value !== 'number') return 'R$ 0,00';
      return value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
    }

    function parseValue(str) {
      if (!str || typeof str !== 'string') return 0;
      return parseFloat(str.replace(/\./g, '').replace(',', '.')) || 0;
    }

    function monthNameToDate(monthName) {
      const map = { janeiro:0, fevereiro:1, março:2, abril:3, maio:4, junho:5, julho:6, agosto:7, setembro:8, outubro:9, novembro:10, dezembro:11 };
      const idx = map[monthName.toLowerCase().trim()];
      return typeof idx === 'number' ? new Date(2024, idx, 1) : null;
    }

    async function fetchAndProcessData() {
      if (!window.Papa || !window.Chart) {
        console.error('Bibliotecas não carregadas.');
        loadingScreen.innerHTML = '<p class="text-red-500 font-bold">Erro ao carregar bibliotecas.</p>';
        return;
      }

      try {
        const promises = Object.entries(URLS).map(([cc, url]) => new Promise((res, rej) => {
          if (!url.startsWith('https://')) return res([]);
          Papa.parse(url, {
            download: true,
            header: true,
            skipEmptyLines: true,
            dynamicTyping: true,
            complete: results => {
              const data = results.data.flatMap(row => Object.entries(row).flatMap(([col, val]) => {
                const dateObj = monthNameToDate(col);
                if (row['Plano financeiro'] && dateObj && val) {
                  return [{ 'Plano Financeiro': row['Plano financeiro'], 'Centro de Custo': cc, 'ValorNumerico': parseValue(String(val)), 'DataObj': dateObj }];
                }
                return [];
              }));
              res(data);
            },
            error: err => rej(err)
          });
        }));

        const all = await Promise.all(promises);
        allData = all.flat();
        if (!allData.length) throw new Error('Nenhum dado carregado.');

        populateMonthFilter();
        updateDashboard();
        setupEventListeners();

        loadingScreen.style.display = 'none';
        dashboardContainer.classList.remove('hidden');
      } catch (err) {
        console.error(err);
        loadingScreen.innerHTML = `<p class="text-red-500 font-bold">Falha ao carregar os dados.</p><p class="text-slate-600 mt-2">${err.message}</p>`;
      }
    }

    function populateMonthFilter() {
      const months = Array.from(new Set(allData.map(r => `${r.DataObj.getFullYear()}-${String(r.DataObj.getMonth()+1).padStart(2,'0')}`))).sort().reverse();
      months.forEach(ms => {
        const [yr, mo] = ms.split('-');
        const opt = document.createElement('option');
        opt.value = ms;
        const d = new Date(yr, mo - 1);
        opt.textContent = d.toLocaleString('pt-BR', { month: 'long', year: 'numeric' }).replace(/^\w/, c => c.toUpperCase());
        monthFilter.appendChild(opt);
      });
    }

    function renderCCTab(cc, data) {
      const container = document.getElementById(`cc${cc}`);
      const filtered = data.filter(r => r['Centro de Custo'] === cc);
      if (!filtered.length) return container.innerHTML = `<p class="text-slate-500">Nenhum dado para este período.</p>`;

      const sums = filtered.reduce((acc, r) => (acc[r['Plano Financeiro']] = (acc[r['Plano Financeiro']] || 0) + r.ValorNumerico, acc), {});
      const total = Object.values(sums).reduce((a,b) => a + b, 0);

      let html = `<h3 class="text-xl font-semibold text-slate-800 mb-4">Total do Período: ${formatCurrency(total)}</h3><div class="overflow-x-auto"><table class="min-w-full"><thead class="bg-slate-50"><tr><th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase">Plano Financeiro</th><th class="px-6 py-3 text-right text-xs font-medium text-slate-500 uppercase">Valor</th></tr></thead><tbody>`;
      Object.entries(sums).sort((a,b)=>b[1]-a[1]).forEach(([plan, val]) => {
        html += `<tr><td class="px-6 py-4 text-sm font-medium text-slate-900">${plan}</td><td class="px-6 py-4 text-sm text-slate-600 text-right">${formatCurrency(val)}</td></tr>`;
      });
      container.innerHTML = html + '</tbody></table></div>';
    }

    function renderTotalTab(data) {
      const container = document.getElementById('total');
      if (!data.length) return container.innerHTML = `<p class="text-slate-500">Nenhum dado para este período.</p>`;

      const sums = data.reduce((acc, r) => (acc[r['Plano Financeiro']] = (acc[r['Plano Financeiro']] || 0) + r.ValorNumerico, acc), {});
      const total = Object.values(sums).reduce((a,b) => a + b, 0);

      let html = `<div class="bg-blue-500 text-white p-6 rounded-lg shadow-lg mb-6"><h3 class="text-lg font-medium">Total Geral Consolidado</h3><p class="text-4xl font-bold">${formatCurrency(total)}</p></div><h4 class="text-lg font-semibold text-slate-800 mb-2">Detalhamento por Plano Financeiro</h4><div class="overflow-x-auto"><table class="min-w-full"><thead class="bg-slate-50"><tr><th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase">Plano Financeiro</th><th class="px-6 py-3 text-right text-xs font-medium text-slate-500 uppercase">Valor Total</th></tr></thead><tbody>`;
      Object.entries(sums).sort((a,b)=>b[1]-a[1]).forEach(([plan, val]) => {
        html += `<tr><td class="px-6 py-4 text-sm font-medium text-slate-900">${plan}</td><td class="px-6 py-4 text-sm text-slate-600 text-right">${formatCurrency(val)}</td></tr>`;
      });
      container.innerHTML = html + '</tbody></table></div>';
    }

    function renderChart(data) {
      const ctx = document.getElementById('mainChart').getContext('2d');
      const plans = [...new Set(data.map(r => r['Plano Financeiro']))].sort();
      const ccs = ['1000','2000','2002'];
      const colors = { '1000':'rgba(59,130,246,0.8)', '2000':'rgba(239,68,68,0.8)', '2002':'rgba(22,163,74,0.8)' };

      const datasets = ccs.map(cc => ({
        label: `CC ${cc}`,
        data: plans.map(p => data.filter(r => r['Centro de Custo'] === cc && r['Plano Financeiro'] === p).reduce((sum, r) => sum + r.ValorNumerico, 0)),
        backgroundColor: colors[cc]
      }));

      if (mainChartInstance) mainChartInstance.destroy();
      mainChartInstance = new Chart(ctx, {
        type: 'bar',
        data: { labels: plans, datasets },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            title: { display: true, text: 'Comparativo de Despesas por Plano Financeiro e CC', font: { size: 16 } },
            tooltip: { callbacks: { label: ctx => `${ctx.dataset.label}: ${formatCurrency(ctx.parsed.y)}` } }
          },
          scales: { y: { beginAtZero: true, ticks: { callback: v => formatCurrency(v) } } }
        }
      });
    }

    function updateDashboard() {
      const sel = monthFilter.value;
      const filtered = sel === 'all' ? allData : allData.filter(r => `${r.DataObj.getFullYear()}-${String(r.DataObj.getMonth()+1).padStart(2,'0')}` === sel);
      renderCCTab('1000', filtered);
      renderCCTab('2000', filtered);
      renderCCTab('2002', filtered);
      renderTotalTab(filtered);
      renderChart(filtered);
    }

    function setupEventListeners() {
      monthFilter.addEventListener('change', updateDashboard);
      tabButtonsContainer.addEventListener('click', e => {
        const btn = e.target.closest('.tab-button'); if (!btn) return;
        tabButtonsContainer.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        tabContentsContainer.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.getElementById(btn.dataset.tab).classList.add('active');
      });
    }

    fetchAndProcessData();
  }
  </script>

</body>
</html>
