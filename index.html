<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GNA Mensal - Centro de Custos</title>
    
    <!-- Google Fonts: Montserrat -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">

    <!-- Biblioteca de Gráficos Plotly.js (Versão Atualizada) -->
    <script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>
    <!-- Biblioteca D3.js para facilitar o carregamento e parsing de CSV -->
    <script src="https://d3js.org/d3.v7.min.js"></script>

    <style>
        /* Paleta de Cores e Fontes - Young Empreendimentos */
        :root {
            --font-family: 'Montserrat', sans-serif;
            --color-orange: #f37021; /* Cor principal da marca */
            --color-dark-gray-main: #343a40; /* Cinza escuro para textos principais */
            --color-light-gray: #f8f9fa;
            --color-medium-gray: #e0e0e0;
            --color-dark-gray-text: #333;
            --color-text: #495057;
            --color-bg: #fdfdfd;
            --color-white: #ffffff;
            --color-success: #2e7d32;
        }

        body {
            font-family: var(--font-family);
            background-color: var(--color-bg);
            color: var(--color-text);
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
        }

        .page-wrapper {
            display: flex;
            flex-direction: column;
            width: 100%;
            max-width: 1400px;
            gap: 25px;
            transition: all 0.3s ease-in-out;
        }

        @media (min-width: 1024px) {
            .page-wrapper {
                flex-direction: row;
            }
        }
        
        .page-wrapper.chart-mode-active .summary-panel {
            display: none;
        }
        
        .page-wrapper.chart-mode-active .dashboard-container {
            width: 100%;
            max-width: 100%;
        }


        .dashboard-container {
            flex-grow: 1;
            background-color: var(--color-white);
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        header {
            padding: 20px 25px;
            background-color: var(--color-white);
            border-bottom: 1px solid var(--color-medium-gray);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        header h1 {
            margin: 0;
            font-size: 1.8em;
            font-weight: 700;
            color: var(--color-dark-gray-main);
        }

        .filter-container {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .filter-container label {
            font-weight: 600;
            color: var(--color-text);
        }

        select, input[type="date"], .multiselect-btn {
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid #ccc;
            background-color: var(--color-white);
            font-family: var(--font-family);
            font-size: 0.95em;
            cursor: pointer;
            transition: border-color 0.3s, box-shadow 0.3s;
        }

        select:hover, input[type="date"]:hover, .multiselect-btn:hover {
            border-color: var(--color-orange);
        }
        select:focus, input[type="date"]:focus, .multiselect-btn:focus {
            outline: none;
            border-color: var(--color-orange);
            box-shadow: 0 0 0 2px rgba(243, 112, 33, 0.2);
        }

        /* Estilos para o filtro de múltipla seleção */
        .multiselect {
            position: relative;
            user-select: none;
        }
        .multiselect-options {
            display: none;
            position: absolute;
            background-color: var(--color-white);
            border: 1px solid var(--color-medium-gray);
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            max-height: 250px;
            overflow-y: auto;
            z-index: 100;
            min-width: 250px;
            margin-top: 5px;
        }
        .multiselect-options.active {
            display: block;
        }
        .multiselect-options label {
            display: block;
            padding: 8px 12px;
            cursor: pointer;
            white-space: nowrap;
        }
        .multiselect-options label:hover {
            background-color: var(--color-light-gray);
        }
        .multiselect-options input {
            margin-right: 8px;
        }


        /* Abas de navegação */
        .tab-nav {
            display: flex;
            background-color: var(--color-light-gray);
            padding: 0 25px;
            border-bottom: 1px solid var(--color-medium-gray);
            flex-wrap: wrap;
            flex-shrink: 0;
        }

        .tab-button {
            padding: 15px 20px;
            cursor: pointer;
            border: none;
            background-color: transparent;
            font-size: 1em;
            font-weight: 600;
            color: var(--color-text);
            position: relative;
            transition: color 0.3s;
        }

        .tab-button:hover {
            color: var(--color-orange);
        }

        .tab-button.active {
            color: var(--color-orange);
        }

        .tab-button.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            width: 100%;
            height: 3px;
            background-color: var(--color-orange);
        }

        /* Conteúdo das abas */
        .tab-content {
            padding: 25px;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }

        .tab-pane { 
            display: none; 
        }
        
        .tab-pane.active { 
            display: flex; 
            flex-direction: column; 
            flex-grow: 1;
            animation: fadeIn 0.5s; 
        }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Tabelas */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--color-medium-gray);
        }

        th {
            background-color: var(--color-light-gray);
            font-weight: 700;
            color: var(--color-dark-gray-text);
        }

        td:last-child {
            text-align: right;
            font-weight: 600;
            color: var(--color-success);
        }
        
        /* Estilo para destacar a linha da soma do pró-labore */
        .highlight-row {
            background-color: #fff9f4 !important; /* Um laranja bem claro */
        }
        .highlight-row td {
            font-weight: 700;
            color: var(--color-dark-gray-main);
        }
        .highlight-row td:last-child {
            color: var(--color-orange) !important;
        }

        /* Aba Total Geral */
        .total-geral-container {
            text-align: center;
            padding: 20px;
            background-color: #fff9f4;
            border: 1px solid #fceadd;
            border-radius: 10px;
        }
        
        .total-geral-valor {
            font-size: 3.5em;
            font-weight: 700;
            color: var(--color-dark-gray-main);
            margin: 10px 0;
        }

        .total-geral-label {
            font-size: 1.2em;
            color: var(--color-orange);
            margin: 0;
        }

        /* Painel de Resumo Lateral */
        .summary-panel {
            flex-basis: 320px;
            flex-shrink: 0;
            background: var(--color-white);
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
            padding: 25px;
            align-self: flex-start;
            transition: all 0.3s ease-in-out;
        }
        .summary-panel h3 {
            margin-top: 0;
            color: var(--color-dark-gray-main);
            font-size: 1.4em;
            border-bottom: 2px solid var(--color-orange);
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        .summary-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid var(--color-medium-gray);
            font-size: 1.1em;
        }
        .summary-item span {
            color: var(--color-text);
        }
        .summary-item strong {
            color: var(--color-dark-gray-main);
            font-weight: 700;
        }
        .summary-item.total {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 2px solid var(--color-dark-gray-main);
            border-bottom: none;
            font-size: 1.2em;
        }
        .summary-item.total strong {
            color: var(--color-orange);
        }
        
        /* Loader */
        #loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.9); display: flex;
            justify-content: center; align-items: center; z-index: 9999;
            font-size: 1.5em; color: var(--color-orange); font-weight: 600;
        }

        /* Rodapé */
        footer {
            padding: 20px 25px;
            margin-top: 10px;
            background-color: var(--color-light-gray);
            border-top: 1px solid var(--color-medium-gray);
            border-radius: 0 0 12px 12px;
            font-size: 0.9em;
            color: var(--color-text);
        }
        footer p {
            margin: 0;
            line-height: 1.5;
        }
        footer strong {
            color: var(--color-dark-gray-text);
        }
    </style>
</head>
<body>

    <div id="loader">Carregando dados...</div>

    <div class="page-wrapper" style="display: none;">
        <aside id="summary-panel" class="summary-panel"></aside>

        <div class="dashboard-container">
            <header>
                <h1>GNA Mensal - Centro de Custos</h1>
                <div class="filter-container">
                    <label for="start-date-filter">De:</label>
                    <input type="date" id="start-date-filter">
                    <label for="end-date-filter">Até:</label>
                    <input type="date" id="end-date-filter">
                </div>
            </header>

            <nav class="tab-nav">
                <button class="tab-button active" data-tab="cc1000">CC 1000</button>
                <button class="tab-button" data-tab="cc2000">CC 2000</button>
                <button class="tab-button" data-tab="cc2002">CC 2002</button>
                <button class="tab-button" data-tab="total">Total Geral</button>
                <button class="tab-button" data-tab="excluded">Planos Financeiros Excluídos</button>
                <button class="tab-button" data-tab="excluded-chart">Gráfico Excluídos</button>
                <button class="tab-button" data-tab="chart">Gráfico Comparativo</button>
            </nav>

            <main class="tab-content">
                <div id="cc1000" class="tab-pane active"></div>
                <div id="cc2000" class="tab-pane"></div>
                <div id="cc2002" class="tab-pane"></div>
                <div id="total" class="tab-pane"></div>
                <div id="excluded" class="tab-pane"></div>
                <div id="excluded-chart" class="tab-pane"></div>
                <div id="chart" class="tab-pane"></div>
            </main>
            
            <footer>
                <p>
                    <strong>Observação:</strong> Para uma análise focada nos custos operacionais, os seguintes planos financeiros foram movidos da visualização principal para a aba "Planos Financeiros Excluídos": 
                    PIS/COFINS/CSLL, Repasses de gestão, Distribuição de dividendos, Recolhimento de impostos, IRPJ, Mútuos, Participações e todos os Pró-Labores individuais (que não sejam da diretoria).
                    A soma dos Pró-Labores de Eduardo, Octavio e Caroline (buscada da planilha "Posição de Caixa") foi consolidada e adicionada ao Centro de Custo 2000.
                </p>
            </footer>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const siengeDataUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSDWx_07uP6nfagmQZEBTQ-MXA9YcEJT5QsZlnt9_F0hx9serB61Dpo9htuR6zGE94tpSzuvFzOIsVW/pub?gid=1286766302&single=true&output=csv';
            const proLaboreUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTkiy-n--R8fAEJJQD2Axayu6LbLSOfYLZsJxQ49xDp560RUzUtH1CeivSvAO71fmE_6sbSAfHvud2Z/pub?gid=1605452357&single=true&output=csv';
            
            let initialAllData = []; 
            let initialExcludedData = [];
            let directorsProLaboreData = [];
            let currentTab = 'cc1000';

            const loader = document.getElementById('loader');
            const pageWrapper = document.querySelector('.page-wrapper');
            const summaryPanel = document.getElementById('summary-panel');

            const exclusionKeywords = [
                'pis', 'cofins', 'csll',
                'repasses de gestão',
                'dividendos',
                'recolhimento de impostos',
                'irpj',
                'mútuo',
                'participações',
                'pró-labore', 'pro-labore'
            ];
            
            const proLaboreDirectorsNames = ['caroline montado volpato', 'eduardo pereira tebaldi', 'octávio portal tebaldi'];

            function parseCurrency(currencyString) {
                if (!currencyString || typeof currencyString !== 'string') return 0;
                return Number(String(currencyString).replace('R$', '').replace(/\./g, '').replace(',', '.').trim());
            }
            
            function formatCurrency(value) {
                return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value);
            }
            
            function parseBrDate(dateStr) {
                if (!dateStr || !/^\d{2}\/\d{2}\/\d{4}$/.test(dateStr)) return null;
                const [day, month, year] = dateStr.split('/');
                return new Date(year, month - 1, day);
            }

            // =======================================================================
            // INÍCIO DA CORREÇÃO
            // A lógica foi reestruturada para seguir a ordem correta de operações:
            // 1. Carregar todos os dados da planilha Sienge.
            // 2. Separar o que é operacional e o que deve ser excluído.
            // 3. Carregar e processar a planilha de Pró-Labore.
            // 4. Adicionar a soma dos Pró-Labores dos diretores aos dados operacionais.
            // =======================================================================
            async function loadAndProcessData() {
                try {
                    const cacheBuster = new Date().getTime();
                    let allDates = [];
                    
                    // 1. Carrega todos os dados brutos da planilha Sienge
                    const siengeTextData = await d3.text(`${siengeDataUrl}&_=${cacheBuster}`);
                    const siengeRows = d3.csvParseRows(siengeTextData);
                    let rawSiengeData = [];
                    if (siengeRows.length > 2) {
                        for (let i = 2; i < siengeRows.length; i++) {
                            const row = siengeRows[i];
                            const hasContent = (cell) => cell != null && cell.trim() !== '';
                            if (hasContent(row[0]) && hasContent(row[1]) && hasContent(row[2])) rawSiengeData.push({ centroCusto: '1000', data: row[0].trim(), planoFinanceiro: row[1].trim(), valor: parseCurrency(row[2]) });
                            if (hasContent(row[4]) && hasContent(row[5]) && hasContent(row[6])) rawSiengeData.push({ centroCusto: '2000', data: row[4].trim(), planoFinanceiro: row[5].trim(), valor: parseCurrency(row[6]) });
                            if (hasContent(row[8]) && hasContent(row[9]) && hasContent(row[10])) rawSiengeData.push({ centroCusto: '2002', data: row[8].trim(), planoFinanceiro: row[9].trim(), valor: parseCurrency(row[10]) });
                        }
                    }

                    // 2. Separa os dados da Sienge em operacionais e excluídos
                    rawSiengeData.forEach(item => {
                        const plan = item.planoFinanceiro.toLowerCase().trim();
                        // Se o plano financeiro contiver qualquer uma das palavras-chave, vai para a lista de excluídos.
                        if (exclusionKeywords.some(keyword => plan.includes(keyword))) {
                            initialExcludedData.push(item);
                        } else {
                            initialAllData.push(item);
                        }
                    });

                    // 3. Carrega e processa a planilha de Pró-Labore
                    const proLaboreTextData = await d3.text(`${proLaboreUrl}&_=${cacheBuster}`);
                    const proLaboreRows = d3.csvParseRows(proLaboreTextData);
                    if (proLaboreRows.length > 1) {
                         for (let i = 1; i < proLaboreRows.length; i++) {
                            const row = proLaboreRows[i];
                            const hasContent = (cell) => cell != null && cell.trim() !== '';
                            if (hasContent(row[0]) && hasContent(row[3]) && hasContent(row[5]) && hasContent(row[6])) {
                                const plano = row[5].trim().toLowerCase();
                                const credor = row[3].trim().toLowerCase();

                                if (plano.includes('pró-labore') || plano.includes('pro-labore')) {
                                    const proLaboreItem = {
                                        centroCusto: '2000', 
                                        data: row[0].trim(),
                                        planoFinanceiro: `Pró-Labore ${row[3].trim()}`,
                                        valor: parseCurrency(row[6])
                                    };
                                    // Separa os diretores (para somar) dos demais (para excluir)
                                    if (proLaboreDirectorsNames.includes(credor)) {
                                        directorsProLaboreData.push(proLaboreItem);
                                    } else {
                                        initialExcludedData.push(proLaboreItem);
                                    }
                                }
                            }
                         }
                    }
                    
                    // Coleta todas as datas para definir os filtros iniciais
                    allDates.push(...initialAllData.map(d => parseBrDate(d.data)), ...initialExcludedData.map(d => parseBrDate(d.data)), ...directorsProLaboreData.map(d => parseBrDate(d.data)));
                    
                    const validDates = allDates.filter(d => d && !isNaN(d.getTime()));
                    if(validDates.length > 0) {
                        const minDate = new Date(Math.min.apply(null, validDates));
                        const maxDate = new Date(Math.max.apply(null, validDates));
                        document.getElementById('start-date-filter').value = minDate.toISOString().split('T')[0];
                        document.getElementById('end-date-filter').value = maxDate.toISOString().split('T')[0];
                    }
                    
                    setupEventListeners();
                    updateDashboard(); // A mágica acontece aqui, onde os dados já separados são renderizados

                    loader.style.display = 'none';
                    pageWrapper.style.display = 'flex';

                } catch (error) {
                    console.error('Erro geral ao carregar os dados:', error);
                    loader.textContent = 'Falha ao carregar os dados. Verifique as URLs das planilhas.';
                }
            }
            // =======================================================================
            // FIM DA CORREÇÃO
            // =======================================================================

            function setupEventListeners() {
                document.getElementById('start-date-filter').addEventListener('change', updateDashboard);
                document.getElementById('end-date-filter').addEventListener('change', updateDashboard);

                document.querySelector('.tab-nav').addEventListener('click', (e) => {
                    if (e.target.classList.contains('tab-button') && e.target.dataset.tab !== currentTab) {
                        currentTab = e.target.dataset.tab;
                        document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                        document.querySelectorAll('.tab-pane').forEach(pane => pane.classList.remove('active'));
                        
                        e.target.classList.add('active');
                        document.getElementById(currentTab).classList.add('active');
                        
                        const isChartTab = currentTab === 'chart' || currentTab === 'excluded-chart';
                        pageWrapper.classList.toggle('chart-mode-active', isChartTab);
                        
                        updateDashboard();
                    }
                });
            }

            function updateDashboard() {
                const startDateValue = document.getElementById('start-date-filter').value;
                const endDateValue = document.getElementById('end-date-filter').value;
                
                let dateFilteredAllData;
                let dateFilteredExcludedData;
                let dateFilteredDirectorsProLabore;

                if (startDateValue && endDateValue) {
                    const [yearS, monthS, dayS] = startDateValue.split('-').map(Number);
                    const start = new Date(yearS, monthS - 1, dayS);

                    const [yearE, monthE, dayE] = endDateValue.split('-').map(Number);
                    const end = new Date(yearE, monthE - 1, dayE);
                    end.setHours(23, 59, 59, 999);

                    const filterByDate = d => {
                        const itemDate = parseBrDate(d.data);
                        return itemDate && itemDate >= start && itemDate <= end;
                    };

                    dateFilteredAllData = initialAllData.filter(filterByDate);
                    dateFilteredExcludedData = initialExcludedData.filter(filterByDate);
                    dateFilteredDirectorsProLabore = directorsProLaboreData.filter(filterByDate);
                } else {
                    dateFilteredAllData = [...initialAllData];
                    dateFilteredExcludedData = [...initialExcludedData];
                    dateFilteredDirectorsProLabore = [...directorsProLaboreData];
                }
                
                // 4. Adiciona a soma do Pró-Labore dos diretores como uma única linha aos dados operacionais
                const proLaboreSumForPeriod = d3.sum(dateFilteredDirectorsProLabore, d => d.valor);
                
                const dataForRender = [...dateFilteredAllData];

                if (proLaboreSumForPeriod > 0) {
                    dataForRender.push({
                        centroCusto: '2000',
                        data: endDateValue, 
                        planoFinanceiro: 'Soma Pró-Labore (Eduardo, Octavio e Caroline)',
                        valor: proLaboreSumForPeriod
                    });
                }
                
                const isExcludedTab = currentTab === 'excluded' || currentTab === 'excluded-chart';
                if (isExcludedTab) {
                    renderExcludedSummary(dateFilteredExcludedData);
                } else {
                    renderMainSummary(dataForRender);
                }

                switch (currentTab) {
                    case 'cc1000':
                    case 'cc2000':
                    case 'cc2002':
                        renderCCTable(currentTab.replace('cc', ''), dataForRender);
                        break;
                    case 'total':
                        renderTotalGeral(dataForRender);
                        break;
                    case 'excluded':
                        renderExcludedTab(dateFilteredExcludedData);
                        break;
                    case 'chart':
                        renderComparisonChart(dataForRender);
                        break;
                    case 'excluded-chart':
                        renderExcludedChart(dateFilteredExcludedData);
                        break;
                }
            }
            
            function getPeriodText() {
                const startDate = document.getElementById('start-date-filter').value;
                const endDate = document.getElementById('end-date-filter').value;
                if (startDate && endDate) {
                    const format = (dateStr) => {
                        const [year, month, day] = dateStr.split('-');
                        return `${day}/${month}/${year}`;
                    };
                    return `${format(startDate)} a ${format(endDate)}`;
                }
                return 'Todo o Período';
            }

            function renderMainSummary(data) {
                const container = document.getElementById('summary-panel');
                const periodText = getPeriodText();

                const total1000 = d3.sum(data.filter(d => d.centroCusto === '1000'), d => d.valor);
                const total2000 = d3.sum(data.filter(d => d.centroCusto === '2000'), d => d.valor);
                const total2002 = d3.sum(data.filter(d => d.centroCusto === '2002'), d => d.valor);
                const grandTotal = total1000 + total2000 + total2002;

                container.innerHTML = `<h3>Resumo (${periodText})</h3>` +
                    `<div class="summary-item"><span>CC 1000</span><strong>${formatCurrency(total1000)}</strong></div>` +
                    `<div class="summary-item"><span>CC 2000</span><strong>${formatCurrency(total2000)}</strong></div>` +
                    `<div class="summary-item"><span>CC 2002</span><strong>${formatCurrency(total2002)}</strong></div>` +
                    `<div class="summary-item total"><span>Total Geral</span><strong>${formatCurrency(grandTotal)}</strong></div>`;
            }

            function renderExcludedSummary(data) {
                const container = document.getElementById('summary-panel');
                const periodText = getPeriodText();

                const total1000 = d3.sum(data.filter(d => d.centroCusto === '1000'), d => d.valor);
                const total2000 = d3.sum(data.filter(d => d.centroCusto === '2000'), d => d.valor);
                const total2002 = d3.sum(data.filter(d => d.centroCusto === '2002'), d => d.valor);
                const grandTotal = total1000 + total2000 + total2002;

                container.innerHTML = `<h3>Resumo Excluídos (${periodText})</h3>` +
                    `<div class="summary-item"><span>CC 1000</span><strong>${formatCurrency(total1000)}</strong></div>` +
                    `<div class="summary-item"><span>CC 2000</span><strong>${formatCurrency(total2000)}</strong></div>` +
                    `<div class="summary-item"><span>CC 2002</span><strong>${formatCurrency(total2002)}</strong></div>` +
                    `<div class="summary-item total"><span>Total Excluído</span><strong>${formatCurrency(grandTotal)}</strong></div>`;
            }

            function createMultiSelectFilter(containerId, data, onFilterChange) {
                const uniquePlans = [...new Set(data.map(d => d.planoFinanceiro))].sort();

                const container = document.getElementById(containerId);
                container.innerHTML = `
                    <div class="filter-container" style="margin-bottom: 20px;">
                        <label>Plano Financeiro:</label>
                        <div class="multiselect" id="multiselect-container-${containerId}">
                            <button class="multiselect-btn" id="multiselect-btn-${containerId}">Selecionar Planos</button>
                            <div class="multiselect-options" id="multiselect-options-${containerId}">
                                <label><input type="checkbox" value="all" checked> (Selecionar Todos)</label>
                                ${uniquePlans.map(p => `<label><input type="checkbox" value="${p}" checked> ${p}</label>`).join('')}
                            </div>
                        </div>
                    </div>
                    <div id="table-container-${containerId}"></div>`;

                const btn = document.getElementById(`multiselect-btn-${containerId}`);
                const optionsDiv = document.getElementById(`multiselect-options-${containerId}`);
                
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    optionsDiv.classList.toggle('active');
                });
                
                optionsDiv.addEventListener('change', (e) => {
                    const allCheckbox = optionsDiv.querySelector('input[value="all"]');
                    const otherCheckboxes = optionsDiv.querySelectorAll('input:not([value="all"])');
                    if (e.target.value === 'all') {
                        otherCheckboxes.forEach(cb => cb.checked = e.target.checked);
                    } else {
                        allCheckbox.checked = [...otherCheckboxes].every(cb => cb.checked);
                    }
                    onFilterChange();
                });
            }

            function renderCCTable(cc, data) {
                const tabId = `cc${cc}`;
                createMultiSelectFilter(tabId, data.filter(d => d.centroCusto === cc), () => updateTableForCC(cc, data));
                updateTableForCC(cc, data);
            }

            function updateTableForCC(cc, ccData) {
                const tableContainer = document.getElementById(`table-container-cc${cc}`);
                const optionsDiv = document.getElementById(`multiselect-options-cc${cc}`);
                const selectedCheckboxes = optionsDiv.querySelectorAll('input[type="checkbox"]:checked');
                const selectedPlans = Array.from(selectedCheckboxes).map(cb => cb.value);

                let dataForTable = ccData.filter(d => d.centroCusto === cc);
                if (!selectedPlans.includes('all')) {
                    dataForTable = dataForTable.filter(d => selectedPlans.includes(d.planoFinanceiro));
                }
                
                const periodText = getPeriodText();
                let tableHTML = `<table><thead><tr><th>Plano Financeiro</th><th>Valor (${periodText})</th></tr></thead><tbody>`;
                const groupedData = d3.rollup(dataForTable, v => d3.sum(v, d => d.valor), d => d.planoFinanceiro);
                const sortedData = Array.from(groupedData.entries()).sort((a, b) => b[1] - a[1]);
                
                sortedData.forEach(([key, value]) => {
                    const isProLaboreSum = key.toLowerCase().includes('soma pró-labore');
                    const rowClass = isProLaboreSum ? 'class="highlight-row"' : '';
                    tableHTML += `<tr ${rowClass}><td>${key}</td><td>${formatCurrency(value)}</td></tr>`;
                });

                tableHTML += '</tbody></table>';
                tableContainer.innerHTML = tableHTML;
            }

            function renderTotalGeral(data) {
                createMultiSelectFilter('total', data, () => updateTotalView(data));
                updateTotalView(data);
            }
            
            function updateTotalView(data) {
                const tableContainer = document.getElementById('table-container-total');
                const optionsDiv = document.getElementById('multiselect-options-total');
                const selectedCheckboxes = optionsDiv.querySelectorAll('input[type="checkbox"]:checked');
                const selectedPlans = Array.from(selectedCheckboxes).map(cb => cb.value);

                let dataForView = data;
                if (!selectedPlans.includes('all')) {
                    dataForView = dataForView.filter(d => selectedPlans.includes(d.planoFinanceiro));
                }
                
                const periodText = getPeriodText();
                let tableHTML = `<table><thead><tr><th>Plano Financeiro</th><th>Centro de Custo</th><th>Valor (${periodText})</th></tr></thead><tbody>`;
                const groupedData = d3.rollup(dataForView, v => d3.sum(v, d => d.valor), d => d.planoFinanceiro, d => d.centroCusto);
                
                let flatData = [];
                groupedData.forEach((ccMap, plan) => {
                    ccMap.forEach((value, cc) => {
                        flatData.push({ plano: plan, centroCusto: cc, valor: value });
                    });
                });

                flatData.sort((a, b) => b.valor - a.valor);

                flatData.forEach(item => {
                    const isProLaboreSum = item.plano.toLowerCase().includes('soma pró-labore');
                    const rowClass = isProLaboreSum ? 'class="highlight-row"' : '';
                    tableHTML += `<tr ${rowClass}><td>${item.plano}</td><td>${item.centroCusto}</td><td>${formatCurrency(item.valor)}</td></tr>`;
                });
                tableHTML += '</tbody></table>';
                tableContainer.innerHTML = tableHTML;
            }

            function renderExcludedTab(data) {
                createMultiSelectFilter('excluded', data, () => updateExcludedTable(data));
                updateExcludedTable(data);
            }

            function updateExcludedTable(data) {
                const tableContainer = document.getElementById('table-container-excluded');
                const optionsDiv = document.getElementById('multiselect-options-excluded');
                const selectedCheckboxes = optionsDiv.querySelectorAll('input[type="checkbox"]:checked');
                const selectedPlans = Array.from(selectedCheckboxes).map(cb => cb.value);

                let dataForTable = data;
                if (!selectedPlans.includes('all')) {
                    dataForTable = dataForTable.filter(d => selectedPlans.includes(d.planoFinanceiro));
                }
                
                dataForTable.sort((a, b) => parseBrDate(b.data) - parseBrDate(a.data));

                let tableHTML = `
                    <table>
                        <thead>
                            <tr><th>Data</th><th>Plano Financeiro</th><th>Centro de Custo</th><th>Valor</th></tr>
                        </thead>
                        <tbody>
                            ${dataForTable.map(row => `
                                <tr>
                                    <td>${row.data}</td>
                                    <td>${row.planoFinanceiro}</td>
                                    <td>${row.centroCusto}</td>
                                    <td>${formatCurrency(row.valor)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>`;
                tableContainer.innerHTML = tableHTML;
            }

            function renderComparisonChart(data) {
                const chartContainer = document.getElementById('chart');
                const periodText = getPeriodText();
                
                const oldCcFilter = document.getElementById('chart-cc-filter');
                const oldCcValue = oldCcFilter ? oldCcFilter.value : 'all';

                chartContainer.innerHTML = `
                    <div class="filter-container" style="margin-bottom: 20px; flex-shrink: 0;">
                        <label for="chart-cc-filter">Visualizar Centro de Custo:</label>
                        <select id="chart-cc-filter">
                            <option value="all">Soma de Todos</option>
                            <option value="1000">CC 1000</option>
                            <option value="2000">CC 2000</option>
                            <option value="2002">CC 2002</option>
                        </select>
                    </div>
                    <div id="plotly-chart" style="width: 100%; height: 100%; flex-grow: 1;"></div>`;
                
                const newCcFilter = document.getElementById('chart-cc-filter');
                newCcFilter.value = oldCcValue; 

                const updatePlot = () => {
                    const selectedCc = newCcFilter.value;
                    const chartDataForRender = (selectedCc === 'all') ? data : data.filter(d => d.centroCusto === selectedCc);

                    const groupedData = d3.rollup(chartDataForRender, v => d3.sum(v, d => d.valor), d => d.planoFinanceiro);
                    
                    const sortedData = Array.from(groupedData.entries()).sort((a, b) => b[1] - a[1]);
                    const labels = sortedData.map(d => d[0]);
                    const originalValues = sortedData.map(d => d[1]);
                    const valuesInThousands = originalValues.map(v => v / 1000);
                    
                    const orangeColor = getComputedStyle(document.documentElement).getPropertyValue('--color-orange').trim();

                    const plotData = [{ 
                        x: labels, 
                        y: valuesInThousands, 
                        customdata: originalValues,
                        hovertemplate: '<b>%{x}</b><br>Valor: R$ %{customdata:,.2f}<extra></extra>',
                        type: 'bar', 
                        marker: { color: orangeColor }
                    }];
                    const layout = {
                        title: { text: `Despesas por Plano Financeiro (${newCcFilter.options[newCcFilter.selectedIndex].text}) - ${periodText}`, font: { family: 'var(--font-family)', size: 18, color: 'var(--color-dark-gray-main)' } },
                        xaxis: { tickangle: -45, rangeslider: { visible: true, bgcolor: 'var(--color-light-gray)', bordercolor: 'var(--color-medium-gray)', borderwidth: 1, thickness: 0.1, } },
                        yaxis: { 
                            title: 'Valor (em mil R$)',
                            showgrid: true,
                            gridcolor: 'var(--color-medium-gray)'
                        },
                        margin: { b: 200, t: 60, l: 80, r: 40 },
                        paper_bgcolor: 'transparent',
                        plot_bgcolor: 'transparent'
                    };
                    const config = { responsive: true, displaylogo: false, modeBarButtonsToRemove: ['select2d', 'lasso2d', 'zoomIn2d', 'zoomOut2d', 'autoScale2d', 'toggleSpikelines'] };
                    
                    Plotly.newPlot('plotly-chart', plotData, layout, config);
                };

                newCcFilter.addEventListener('change', updatePlot);
                
                updatePlot();
            }
            
            function renderExcludedChart(data) {
                const chartContainer = document.getElementById('excluded-chart');
                const uniqueCCs = ['Todos', ...new Set(data.map(d => d.centroCusto))].sort();

                const oldCcFilter = document.getElementById('excluded-chart-cc-filter');
                const oldCcValue = oldCcFilter ? oldCcFilter.value : 'Todos';

                chartContainer.innerHTML = `
                    <div class="filter-container" style="margin-bottom: 20px; flex-shrink: 0;">
                        <label for="excluded-chart-cc-filter">Visualizar Centro de Custo:</label>
                        <select id="excluded-chart-cc-filter">
                             ${uniqueCCs.map(cc => `<option value="${cc}">${cc === 'Todos' ? 'Todos' : `CC ${cc}`}</option>`).join('')}
                        </select>
                    </div>
                    <div id="plotly-excluded-chart" style="width: 100%; height: 100%; flex-grow: 1;"></div>`;
                
                const newCcFilter = document.getElementById('excluded-chart-cc-filter');
                newCcFilter.value = oldCcValue;

                const updatePlot = () => {
                    const selectedCc = newCcFilter.value;
                    let chartDataForRender = data;
                    if (selectedCc !== 'Todos') {
                        chartDataForRender = data.filter(d => d.centroCusto === selectedCc);
                    }

                    const groupedData = d3.rollup(chartDataForRender, v => d3.sum(v, d => d.valor), d => d.planoFinanceiro);
                    
                    const sortedData = Array.from(groupedData.entries()).sort((a, b) => b[1] - a[1]);
                    const labels = sortedData.map(d => d[0]);
                    const originalValues = sortedData.map(d => d[1]);
                    const valuesInThousands = originalValues.map(v => v / 1000);
                    
                    const orangeColor = getComputedStyle(document.documentElement).getPropertyValue('--color-orange').trim();

                    const plotData = [{ 
                        x: labels, 
                        y: valuesInThousands,
                        customdata: originalValues,
                        hovertemplate: '<b>%{x}</b><br>Valor: R$ %{customdata:,.2f}<extra></extra>',
                        type: 'bar', 
                        marker: { color: orangeColor } 
                    }];
                    const layout = {
                        title: { text: `Despesas por Plano Financeiro Excluído (${newCcFilter.options[newCcFilter.selectedIndex].text})`, font: { family: 'var(--font-family)', size: 18, color: 'var(--color-dark-gray-main)' } },
                        xaxis: { tickangle: -45, rangeslider: { visible: true, bgcolor: 'var(--color-light-gray)', bordercolor: 'var(--color-medium-gray)', borderwidth: 1, thickness: 0.1, } },
                        yaxis: { 
                            title: 'Valor (em mil R$)',
                            showgrid: true,
                            gridcolor: 'var(--color-medium-gray)'
                        },
                        margin: { b: 200, t: 60, l: 80, r: 40 },
                        paper_bgcolor: 'transparent',
                        plot_bgcolor: 'transparent'
                    };
                    const config = { responsive: true, displaylogo: false, modeBarButtonsToRemove: ['select2d', 'lasso2d', 'zoomIn2d', 'zoomOut2d', 'autoScale2d', 'toggleSpikelines'] };
                    
                    Plotly.newPlot('plotly-excluded-chart', plotData, layout, config);
                };

                newCcFilter.addEventListener('change', updatePlot);
                updatePlot();
            }

            // Fechar dropdowns de multiselect ao clicar fora
            document.addEventListener('click', (e) => {
                document.querySelectorAll('.multiselect-options.active').forEach(optionsDiv => {
                    if (!optionsDiv.parentElement.contains(e.target)) {
                        optionsDiv.classList.remove('active');
                    }
                });
            });

            loadAndProcessData();
        });
    </script>
</body>
</html>

