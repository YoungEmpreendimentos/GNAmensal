<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Financeiro</title>
    <!-- Tailwind CSS para estilização rápida -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- PapaParse para ler o arquivo CSV do Google Sheets -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/papaparse/5.3.2/papaparse.min.js"></script>
    <!-- Chart.js para criar os gráficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Estilo para a fonte e cores do tema */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f1f5f9; /* slate-100 */
        }
        /* Estilo para a aba ativa */
        .tab-button.active {
            border-color: #3b82f6; /* blue-500 */
            background-color: #3b82f6;
            color: white;
        }
        /* Estilo para o conteúdo da aba inativa (escondido) */
        .tab-content {
            display: none;
        }
        /* Estilo para o conteúdo da aba ativa (visível) */
        .tab-content.active {
            display: block;
        }
        /* Animação de carregamento */
        .loader {
            border: 8px solid #f3f3f3; /* Light grey */
            border-top: 8px solid #3b82f6; /* Blue */
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div id="loading-screen" class="fixed inset-0 bg-white bg-opacity-90 flex flex-col justify-center items-center z-50">
        <div class="loader"></div>
        <p class="mt-4 text-lg text-slate-700">Carregando dados da planilha...</p>
    </div>

    <div class="max-w-7xl mx-auto">
        <header class="mb-6">
            <h1 class="text-3xl font-bold text-slate-800">Dashboard Financeiro</h1>
            <p class="text-slate-600">Análise de Despesas por Centro de Custo</p>
        </header>

        <!-- Filtro de Mês -->
        <div class="mb-6 bg-white p-4 rounded-lg shadow-sm">
            <label for="month-filter" class="block text-sm font-medium text-slate-700 mb-2">Filtrar por Mês:</label>
            <select id="month-filter" class="w-full md:w-1/3 p-2 border border-slate-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                <option value="all">Todo o período</option>
            </select>
        </div>

        <!-- Navegação por Abas -->
        <div class="mb-4 border-b border-slate-200">
            <nav class="flex flex-wrap -mb-px" id="tab-buttons">
                <button data-tab="cc1000" class="tab-button active text-slate-600 hover:text-blue-600 whitespace-nowrap py-4 px-6 border-b-2 font-medium text-sm transition-colors duration-200">
                    CC 1000 - Empreendimentos
                </button>
                <button data-tab="cc2000" class="tab-button text-slate-600 hover:text-blue-600 whitespace-nowrap py-4 px-6 border-b-2 font-medium text-sm transition-colors duration-200">
                    CC 2000 - Matriz
                </button>
                <button data-tab="cc2002" class="tab-button text-slate-600 hover:text-blue-600 whitespace-nowrap py-4 px-6 border-b-2 font-medium text-sm transition-colors duration-200">
                    CC 2002 - Novos Negócios
                </button>
                <button data-tab="total" class="tab-button text-slate-600 hover:text-blue-600 whitespace-nowrap py-4 px-6 border-b-2 font-medium text-sm transition-colors duration-200">
                    Total Geral
                </button>
                <button data-tab="chart" class="tab-button text-slate-600 hover:text-blue-600 whitespace-nowrap py-4 px-6 border-b-2 font-medium text-sm transition-colors duration-200">
                    Gráfico Comparativo
                </button>
            </nav>
        </div>

        <!-- Conteúdo das Abas -->
        <div id="tab-contents">
            <div id="cc1000" class="tab-content active p-4 bg-white rounded-lg shadow"></div>
            <div id="cc2000" class="tab-content p-4 bg-white rounded-lg shadow"></div>
            <div id="cc2002" class="tab-content p-4 bg-white rounded-lg shadow"></div>
            <div id="total" class="tab-content p-4 bg-white rounded-lg shadow"></div>
            <div id="chart" class="tab-content p-4 bg-white rounded-lg shadow">
                <canvas id="mainChart"></canvas>
            </div>
        </div>
    </div>

    <script type="module">
        // URLs para cada aba da sua planilha
        const URLS = {
            '1000': 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSDWx_07uP6nfagmQZEBTQ-MXA9YcEJT5QsZlnt9_F0hx9serB61Dpo9htuR6zGE94tpSzuvFzOIsVW/pub?gid=0&single=true&output=csv',
            '2000': 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSDWx_07uP6nfagmQZEBTQ-MXA9YcEJT5QsZlnt9_F0hx9serB61Dpo9htuR6zGE94tpSzuvFzOIsVW/pub?gid=109919740&single=true&output=csv',
            '2002': 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSDWx_07uP6nfagmQZEBTQ-MXA9YcEJT5QsZlnt9_F0hx9serB61Dpo9htuR6zGE94tpSzuvFzOIsVW/pub?gid=1836102146&single=true&output=csv'
        };

        let allData = [];
        let mainChartInstance = null;

        const monthFilter = document.getElementById('month-filter');
        const tabButtonsContainer = document.getElementById('tab-buttons');
        const tabContentsContainer = document.getElementById('tab-contents');
        const loadingScreen = document.getElementById('loading-screen');

        /**
         * Formata um número para o padrão de moeda brasileiro (BRL).
         * @param {number} value - O número a ser formatado.
         * @returns {string} - O valor formatado como moeda.
         */
        function formatCurrency(value) {
            return value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        }

        /**
         * Converte uma string de valor da planilha para um número.
         * Ex: "1.234,56" -> 1234.56
         * @param {string} valueStr - A string do valor.
         * @returns {number} - O valor convertido para número.
         */
        function parseValue(valueStr) {
            if (!valueStr || typeof valueStr !== 'string') return 0;
            return parseFloat(valueStr.replace(/\./g, '').replace(',', '.')) || 0;
        }
        
        /**
         * Converte uma data no formato DD/MM/YYYY para um objeto Date.
         * @param {string} dateStr - A data como string.
         * @returns {Date|null} - O objeto Date ou null se inválido.
         */
        function parseDate(dateStr) {
            if (!dateStr) return null;
            const parts = dateStr.split('/');
            if (parts.length === 3) {
                // Formato: DD/MM/YYYY
                return new Date(parts[2], parts[1] - 1, parts[0]);
            }
            return null;
        }

        /**
         * Busca e processa os dados de todas as planilhas.
         */
        async function fetchAndProcessData() {
            try {
                const fetchPromises = Object.entries(URLS).map(([cc, url]) => 
                    new Promise((resolve, reject) => {
                        Papa.parse(url, {
                            download: true,
                            header: true,
                            skipEmptyLines: true,
                            complete: (results) => {
                                // Adiciona o centro de custo a cada registro
                                const processedData = results.data.map(row => ({
                                    ...row,
                                    'Centro de Custo': cc,
                                    'ValorNumerico': parseValue(row.Valor),
                                    'DataObj': parseDate(row.Data)
                                })).filter(row => row.DataObj); // Filtra linhas sem data válida
                                resolve(processedData);
                            },
                            error: (error) => reject(error)
                        });
                    })
                );

                const results = await Promise.all(fetchPromises);
                allData = results.flat(); // Combina os dados de todas as abas em um único array

                populateMonthFilter();
                updateDashboard();
                setupEventListeners();
                
                loadingScreen.style.display = 'none';

            } catch (error) {
                console.error("Erro ao carregar os dados:", error);
                loadingScreen.innerHTML = '<p class="text-red-500 font-bold">Falha ao carregar os dados. Verifique o console para mais detalhes.</p>';
            }
        }

        /**
         * Popula o seletor de filtro de mês com base nos dados carregados.
         */
        function populateMonthFilter() {
            const months = new Set();
            allData.forEach(row => {
                if (row.DataObj) {
                    const year = row.DataObj.getFullYear();
                    const month = (row.DataObj.getMonth() + 1).toString().padStart(2, '0');
                    months.add(`${year}-${month}`);
                }
            });

            const sortedMonths = Array.from(months).sort().reverse();
            sortedMonths.forEach(monthStr => {
                const [year, month] = monthStr.split('-');
                const option = document.createElement('option');
                option.value = monthStr;
                // Formata o texto da opção para "Mês/Ano"
                option.textContent = new Date(year, month - 1).toLocaleString('pt-BR', { month: 'long', year: 'numeric' }).replace(/^\w/, c => c.toUpperCase());
                monthFilter.appendChild(option);
            });
        }
        
        /**
         * Renderiza o conteúdo de uma aba de Centro de Custo.
         * @param {string} cc - O código do Centro de Custo ('1000', '2000', '2002').
         * @param {Array} data - Os dados filtrados para o período selecionado.
         */
        function renderCCTab(cc, data) {
            const container = document.getElementById(`cc${cc}`);
            const ccData = data.filter(row => row['Centro de Custo'] === cc);
            
            if (ccData.length === 0) {
                container.innerHTML = `<p class="text-slate-500">Nenhum dado encontrado para este período.</p>`;
                return;
            }

            const aggregated = ccData.reduce((acc, row) => {
                const plan = row['Plano Financeiro'];
                if (!acc[plan]) {
                    acc[plan] = 0;
                }
                acc[plan] += row.ValorNumerico;
                return acc;
            }, {});

            const total = Object.values(aggregated).reduce((sum, val) => sum + val, 0);

            let tableHTML = `
                <div class="mb-4">
                    <h3 class="text-xl font-semibold text-slate-800">Total do Período: ${formatCurrency(total)}</h3>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white">
                        <thead class="bg-slate-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Plano Financeiro</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-slate-500 uppercase tracking-wider">Valor</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-200">
            `;

            const sortedPlans = Object.entries(aggregated).sort(([,a], [,b]) => b - a);

            for (const [plan, value] of sortedPlans) {
                tableHTML += `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-slate-900">${plan}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-600 text-right">${formatCurrency(value)}</td>
                    </tr>
                `;
            }

            tableHTML += `
                        </tbody>
                    </table>
                </div>
            `;
            container.innerHTML = tableHTML;
        }

        /**
         * Renderiza a aba de Total Geral.
         * @param {Array} data - Os dados filtrados para o período.
         */
        function renderTotalTab(data) {
            const container = document.getElementById('total');
            if (data.length === 0) {
                container.innerHTML = `<p class="text-slate-500">Nenhum dado encontrado para este período.</p>`;
                return;
            }

            const aggregated = data.reduce((acc, row) => {
                const plan = row['Plano Financeiro'];
                if (!acc[plan]) {
                    acc[plan] = 0;
                }
                acc[plan] += row.ValorNumerico;
                return acc;
            }, {});

            const grandTotal = Object.values(aggregated).reduce((sum, val) => sum + val, 0);

            let contentHTML = `
                <div class="bg-blue-500 text-white p-6 rounded-lg shadow-lg mb-6">
                    <h3 class="text-lg font-medium">Total Geral Consolidado</h3>
                    <p class="text-4xl font-bold">${formatCurrency(grandTotal)}</p>
                </div>
                <h4 class="text-lg font-semibold text-slate-800 mb-2">Detalhamento por Plano Financeiro</h4>
                 <div class="overflow-x-auto">
                    <table class="min-w-full bg-white">
                        <thead class="bg-slate-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Plano Financeiro</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-slate-500 uppercase tracking-wider">Valor Total</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-200">
            `;

            const sortedPlans = Object.entries(aggregated).sort(([,a], [,b]) => b - a);

            for (const [plan, value] of sortedPlans) {
                contentHTML += `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-slate-900">${plan}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-600 text-right">${formatCurrency(value)}</td>
                    </tr>
                `;
            }

             contentHTML += `
                        </tbody>
                    </table>
                </div>
            `;

            container.innerHTML = contentHTML;
        }

        /**
         * Renderiza o gráfico comparativo.
         * @param {Array} data - Os dados filtrados para o período.
         */
        function renderChart(data) {
            const ctx = document.getElementById('mainChart').getContext('2d');
            
            const plans = [...new Set(data.map(row => row['Plano Financeiro']))].sort();
            const ccs = ['1000', '2000', '2002'];
            const colors = {
                '1000': 'rgba(59, 130, 246, 0.8)', // blue-500
                '2000': 'rgba(239, 68, 68, 0.8)',  // red-500
                '2002': 'rgba(22, 163, 74, 0.8)'   // green-600
            };
            
            const datasets = ccs.map(cc => {
                return {
                    label: `CC ${cc}`,
                    data: plans.map(plan => {
                        return data
                            .filter(row => row['Centro de Custo'] === cc && row['Plano Financeiro'] === plan)
                            .reduce((sum, row) => sum + row.ValorNumerico, 0);
                    }),
                    backgroundColor: colors[cc],
                    borderColor: colors[cc].replace('0.8', '1'),
                    borderWidth: 1
                };
            });

            if (mainChartInstance) {
                mainChartInstance.destroy();
            }

            mainChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: plans,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Comparativo de Despesas por Plano Financeiro e Centro de Custo',
                            font: { size: 16 }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += formatCurrency(context.parsed.y);
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatCurrency(value);
                                }
                            }
                        }
                    }
                }
            });
        }

        /**
         * Atualiza todo o dashboard com base no filtro de mês selecionado.
         */
        function updateDashboard() {
            const selectedMonth = monthFilter.value;
            let filteredData;

            if (selectedMonth === 'all') {
                filteredData = allData;
            } else {
                filteredData = allData.filter(row => {
                    if (!row.DataObj) return false;
                    const year = row.DataObj.getFullYear();
                    const month = (row.DataObj.getMonth() + 1).toString().padStart(2, '0');
                    return `${year}-${month}` === selectedMonth;
                });
            }

            renderCCTab('1000', filteredData);
            renderCCTab('2000', filteredData);
            renderCCTab('2002', filteredData);
            renderTotalTab(filteredData);
            renderChart(filteredData);
        }

        /**
         * Configura os event listeners para os filtros e abas.
         */
        function setupEventListeners() {
            monthFilter.addEventListener('change', updateDashboard);

            tabButtonsContainer.addEventListener('click', (e) => {
                const button = e.target.closest('.tab-button');
                if (!button) return;

                const tabId = button.dataset.tab;

                // Atualiza botões
                tabButtonsContainer.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');

                // Atualiza conteúdo
                tabContentsContainer.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                document.getElementById(tabId).classList.add('active');
            });
        }

        // Inicia o processo de carregamento dos dados
        fetchAndProcessData();

    </script>
</body>
</html>
